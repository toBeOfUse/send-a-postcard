<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Write it on a postcard</title>
    <style>
      html {
        margin: 0;
        width: 100%;
        height: 100%;
      }
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        background-image: url("skybg.jpg");
        background-size: cover;
        background-position: center;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      #card-container {
        width: 50%;
        position: relative;
        perspective: 600px;
      }
      #postcard {
        width: 100%;
        height: auto;
        backface-visibility: hidden;
      }
      #card-front {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        transform: rotateY(180deg);
        backface-visibility: hidden;
      }
      #card-back {
        backface-visibility: hidden;
      }
      #writespace {
        position: absolute;
        left: 2.5%;
        top: 10%;
        width: 55%;
        height: 70%;
        font-size: 16px;
        padding: 3px;
        backface-visibility: hidden;
      }
      @media (max-width: 500px) {
        #writepace {
          font-size: 10px;
        }
        #card-container {
          width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <div id="card-container">
      <img src="covers/Harmandir_Sahib,_Amritsar,_India.jpg" id="card-front" />
      <div id="card-back">
        <img src="postcard.svg" id="postcard" />
        <p contenteditable id="writespace">Write...</p>
      </div>
    </div>
    <script>
      const frontImages = [
        "Vista_de_Ã…lesund_desde_Aksla,_Noruega,_2019-09-01,_DD_16.jpg",
        "Senden,_Schloss_Senden_--_2020_--_0486-90.jpg",
        "Duisburg,_Landschaftspark_Duisburg-Nord_--_2020_--_7772.jpg",
        "Harmandir_Sahib,_Amritsar,_India.jpg",
      ];
      let currentFrontImage = 0;
      function setFrontImage() {
        const file = frontImages[currentFrontImage];
        document.querySelector("#card-front").src = "covers/" + file;
        currentFrontImage += 1;
        currentFrontImage %= frontImages.length;
      }
      setFrontImage();
      const ambientTiltRange = 40;
      const card = document.querySelector("#card-back");
      const cardFront = document.querySelector("#card-front");
      let cardAnimating = false;
      let cardYDeg = 0;
      let cardXDeg = 0;
      let ambientXDeg = 0;
      let ambientYDeg = 0;
      function applyCardDeg() {
        card.style.transform =
          `rotate3d(1, 0, 0, ${cardXDeg}deg) ` +
          `rotate3d(0, 1, 0, ${cardYDeg}deg)`;
        cardFront.style.transform =
          `rotate3d(1, 0, 0, ${cardXDeg}deg) ` +
          `rotate3d(0, 1, 0, ${cardYDeg + 180}deg)`;
      }
      function animateSpin() {
        cardAnimating = true;
        const degreesPerMS = 180 / 1000;
        let startTime = -1;
        const initialYDeg = cardYDeg;
        const step = (timestamp) => {
          cardXDeg = ambientXDeg;
          if (startTime == -1) {
            startTime = timestamp;
            requestAnimationFrame(step);
          } else {
            const timePassed = timestamp - startTime;
            const degrees = degreesPerMS * timePassed + initialYDeg;
            if (degrees - 360 >= ambientYDeg) {
              cardYDeg = ambientYDeg;
              applyCardDeg();
              setFrontImage();
              cardAnimating = false;
            } else {
              cardYDeg = degrees;
              applyCardDeg();
              requestAnimationFrame(step);
            }
          }
        };
        requestAnimationFrame(step);
      }
      window.addEventListener("mousemove", (e) => {
        const x = e.clientX / window.innerWidth - 0.5;
        const y = e.clientY / window.innerHeight - 0.5;
        ambientXDeg = -y * ambientTiltRange;
        ambientYDeg = x * ambientTiltRange;
        if (!cardAnimating) {
          cardXDeg = ambientXDeg;
          cardYDeg = ambientYDeg;
          applyCardDeg();
        }
      });
      document.querySelector("#postcard").addEventListener("click", (e) => {
        e.preventDefault();
        animateSpin();
      });
      window.addEventListener("touchend", (e) => {
        if (e.target.id != "writespace") {
          // prevent mousemove from triggering
          e.stopPropagation();
          e.preventDefault();
        }
        if (e.target.id == "postcard") {
          animateSpin();
        }
      });
      document.querySelector("#writespace").addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
      document
        .querySelector("#writespace")
        .addEventListener("mousemove", (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      let prevBeta = undefined;
      let prevGamma = undefined;
      console.log("adding deviceorientation listener");
      window.addEventListener(
        "deviceorientation",
        (e) => {
          console.log("device orientation listener fired");
          if (prevBeta === undefined) {
            prevBeta = e.beta;
            prevGamma = e.gamma;
          } else {
            const deltaBeta = e.beta - prevBeta;
            const deltaGamma = e.gamma - prevGamma;
            ambientXDeg += deltaBeta;
            ambientXDeg = Math.min(ambientTiltRange / 2, ambientXDeg);
            ambientXDeg = Math.max(-ambientTiltRange / 2, ambientXDeg);
            ambientYDeg = deltaGamma;
            ambientYDeg = Math.min(ambientTiltRange / 2, ambientYDeg);
            ambientYDeg = Math.max(-ambientTiltRange / 2, ambientYDeg);
            applyCardDeg();
          }
        },
        true
      );
    </script>
  </body>
</html>
