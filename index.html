<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Write it on a postcard</title>
    <style>
      html {
        margin: 0;
        width: 100%;
        height: 100%;
      }
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        background-image: url("skybg.jpg");
        background-size: cover;
        background-position: center;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      #card-container {
        width: 50%;
        position: relative;
        perspective: 600px;
      }
      #postcard {
        width: 100%;
        height: auto;
        backface-visibility: hidden;
      }
      #card-front {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        transform: rotateY(180deg);
        backface-visibility: hidden;
      }
      #card-back {
        backface-visibility: hidden;
      }
      #writespace {
        position: absolute;
        left: 2.5%;
        top: 10%;
        width: 55%;
        height: 70%;
        font-size: 16px;
        padding: 3px;
        backface-visibility: hidden;
      }
    </style>
  </head>
  <body>
    <div id="card-container">
      <img src="covers/Harmandir_Sahib,_Amritsar,_India.jpg" id="card-front" />
      <div id="card-back">
        <img src="postcard.svg" id="postcard" />
        <p contenteditable id="writespace">Write...</p>
      </div>
    </div>
    <script>
      const card = document.querySelector("#card-back");
      const cardFront = document.querySelector("#card-front");
      let cardAnimating = false;
      let cardYDeg = 0;
      let cardXDeg = 0;
      let ambientXDeg = 0;
      let ambientYDeg = 0;
      function applyCardDeg() {
        card.style.transform =
          `rotate3d(1, 0, 0, ${cardXDeg}deg) ` +
          `rotate3d(0, 1, 0, ${cardYDeg}deg)`;
        cardFront.style.transform =
          `rotate3d(1, 0, 0, ${cardXDeg}deg) ` +
          `rotate3d(0, 1, 0, ${cardYDeg + 180}deg)`;
      }
      function animateSpin() {
        cardAnimating = true;
        const degreesPerMS = 180 / 1000;
        let startTime = -1;
        const initialYDeg = cardYDeg;
        const step = (timestamp) => {
          cardXDeg = ambientXDeg;
          if (startTime == -1) {
            startTime = timestamp;
            requestAnimationFrame(step);
          } else {
            const timePassed = timestamp - startTime;
            const degrees = degreesPerMS * timePassed + initialYDeg;
            if (degrees - 360 >= ambientYDeg) {
              cardYDeg = ambientYDeg;
              applyCardDeg();
              cardAnimating = false;
            } else {
              cardYDeg = degrees;
              applyCardDeg();
              requestAnimationFrame(step);
            }
          }
        };
        requestAnimationFrame(step);
      }
      window.addEventListener("mousemove", (e) => {
        const x = e.clientX / window.innerWidth - 0.5;
        const y = e.clientY / window.innerHeight - 0.5;
        ambientXDeg = -y * 40;
        ambientYDeg = x * 40;
        if (!cardAnimating) {
          cardXDeg = ambientXDeg;
          cardYDeg = ambientYDeg;
          applyCardDeg();
        }
      });
      document.querySelector("#postcard").addEventListener("click", (e) => {
        e.preventDefault();
        animateSpin();
      });
      document
        .querySelector("#writespace")
        .addEventListener("click", (e) => e.preventDefault());
    </script>
  </body>
</html>
